<html>
<head>
<style>
	.div-table {
		display: table;
		border: 1px solid black;
		border-bottom:0;
		border-right:0;
	}
	.div-row {
		display: table-row;
	}

	.div-row > div {
		display: table-cell;
		border: 1px solid black;
		border-top:0;
		border-left:0;
		width: 30px;
		height: 30px;
		text-align: center;
		vertical-align: middle;
		cursor: pointer;
	}

	.div-row > div.active {
		background-color: aquamarine;
	}
</style>
<script>
var game = function( cols, rows, elements ) {
	var me = this;
	me.debug = true;
	me.cols = cols;
	me.rows = rows;
	me.elements = elements;
	me.table = [];
	me.collisions = [];

	me.initTable = function() {
		for( var y=0; y<me.rows; y++ ) {
			var line = [];
			for( var x=0; x<me.cols; x++ ) {
				line.push(rand( 1, elements ));
			}
			me.table.push(line);
		}
/*
		me.table = [
			[1,1,1,3,2,1,3],
			[1,3,3,3,2,3,3],
			[2,1,1,2,3,3,3]
		];
/
		me.table = [
			[2,3,2,1,2,1,2],
			[2,2,1,3,3,1,3],
			[2,2,2,2,2,2,2]
		];
		/**/
	};

	me.hasVerticalCollision = function( x, y ) {
		return me.hasVerticalCollisionWith( x, y, me.table[y][x] );
	};

	me.hasVerticalCollisionWith = function( x, y, value ) {
		var count = 0;
		var sigmaY = y > 2 ? y-2 : 0;
		var maxY = y+2 >= me.rows ? me.rows-1 : y+2;
		for( sigmaY; sigmaY<=maxY; sigmaY++ ) {
			if( ( me.table[sigmaY][x] == value ) || ( sigmaY === y ) ) {
				count++
			} else {
				count = 0;
			}
			if( count === 3 ) {
				return true;
			}
		}
		return false
	};


	me.hasHorizontalCollision = function( x, y ) {
		return me.hasHorizontalCollisionWith( x, y, me.table[y][x] );
	};

	me.hasHorizontalCollisionWith = function( x, y, value ) {
		var count = 0;
		var sigmaX = x > 2 ? x-2 : 0;
		var maxX = x+2 >= me.cols ? me.cols-1 : x+2;
		for( sigmaX; sigmaX<=maxX; sigmaX++ ) {
			if( ( me.table[y][sigmaX] == value ) || ( sigmaX === x ) ) {
				count++
			} else {
				count = 0;
			}
			if( count === 3 ) {
				return true;
			}
		}
		return false
	};

	me.markCollisions = function() {
		var collisions = [];
		var addCollision = function( x, y ) {
			var key = x+'_'+y;
			if( !collisions[key] ) {
				collisions[key] = true;
				me.collisions.push( { x: x, y: y } )
			}
		};
		me.collisions = [];

		for( var x=0; x<me.cols; x++ ) {
			for( var y=0; y<me.rows; y++ ) {
				if( me.hasVerticalCollision( x, y ) || me.hasHorizontalCollision( x, y ) ) {
					addCollision( x, y );
				}
			}
		}
		for( var key in me.collisions ) {
			var cell = me.collisions[key];
			me.table[cell.y][cell.x] = 0;
		}


	};

	me.moveCollisions = function() {
		while( me.collisions.length ) {
			var collision = me.collisions.pop();
			if( !me.table[collision.y][collision.x] ) {
				for( var x=0; x<me.cols; x++ ) {
					if( !me.table[collision.y][x] ) {
						me.table[collision.y].splice( x, 1);
						me.table[collision.y].push( rand( 1, elements ) );
						x--;
					}
				}
			}
		}
	};

	me.init = function() {
		me.initTable();
		if( !me.debug ) {
			while( true ) {
				me.markCollisions();
				if( me.collisions.length == 0 ) break;
				me.moveCollisions();
			}
		}
		me.view = new gameView(me);
	};
	me.init();
};

var cellView = {
	getCellId: function( x, y ) {
		return 'c_' + x + '_' + y;
	},
	getCell: function( x, y )
	{
		return document.getElementById( this.getCellId( x, y ) );
	},
	setActive: function( x, y ) {
		var cell = this.getCell( x, y );
		cell.className = 'active';
	},
	unsetActive: function( x, y ) {
		var cell = this.getCell( x, y );
		cell.className = '';
	}
};

var gameView = function( game ) {
	var me = this;
	me.activeCell = null;
	me.init = function() {
		me.gameField = document.createElement( 'div' );
		me.gameField.className = "div-table";
		for( var y=0; y<game.rows; y++ ) {
			var row_div = document.createElement( 'div' );
			row_div.className = "div-row";
			for( var x=0; x<game.cols; x++ ) {
				var cell = document.createElement( 'div' );
				cell.id = cellView.getCellId( x, y );
				cell.innerHTML = game.table[y][x];
				(function( cell_x, cell_y ){
					cell.addEventListener( 'click', function(event) { return me.cellClick( cell_x, cell_y, event ) } );
				}(x,y));
				row_div.appendChild( cell );
			}
			me.gameField.appendChild( row_div );
		}
		document.body.appendChild( me.gameField );
	};

	me.setActiveCell = function( x, y ) {
		console.log( 'select ' + x + ' ' + y );
		cellView.setActive( x, y );
		me.activeCell = { x: x, y: y };

	};

	me.unsetActiveCell = function() {
		console.log( 'unselect' );
		if( me.activeCell !== null ) {
			cellView.unsetActive( me.activeCell.x, me.activeCell.y );
			me.activeCell = null;
		}
	};

	me.isSwitchableCell = function( x, y ) {
		return 	( ( me.activeCell.y == y ) && ( me.activeCell.x-1 == x || me.activeCell.x+1 == x ) ) ||
				( ( me.activeCell.x == x ) && ( me.activeCell.y-1 == y || me.activeCell.y+1 == y ) )
	};


	me.cellClick = function( x, y, event){
		if( me.activeCell == null ){
			me.setActiveCell( x, y );
		} else if( me.activeCell.x != undefined && me.activeCell.y != undefined ) {
			if( me.activeCell.x == x && me.activeCell.y == y ) {
				me.unsetActiveCell();
			} else if( me.isSwitchableCell( x, y ) ) {
			/*Before checking we should switch elements
				if( game.hasHorizontalCollision( x, y ) || game.hasVerticalCollision( x, y ) ) {

				}*/
				console.log( 'check collision' );
			} else {
				me.unsetActiveCell();
				me.setActiveCell( x, y );
			}
		}
	};

	me.update = function() {
		if( game.debug ) {
			/* Print table step by step
			me.init();
			*/
		}
		for( var x=0; x<game.cols; x++ ) {
			for( var y=0; y<game.rows; y++ ) {
				me.gameField.children[y].children[x].innerHTML = game.table[y][x];
			}
		}
	};
	me.init();
};


var rand = function(min, max) {
	var argc = arguments.length;
	if (argc === 0) {
		min = 0;
		max = 2147483647;
	} else if (argc === 1) {
		throw new Error('Warning: rand() expects exactly 2 parameters, 1 given');
	}
	return Math.floor(Math.random() * (max - min + 1)) + min;
}
</script>
</head>
<body>

<script>
	var gameObj = new game( 7, 3, 3 );
</script>
<button onclick="gameObj.markCollisions();gameObj.view.update()">check</button>
<button onclick="gameObj.moveCollisions();gameObj.view.update()">move</button>

</body>
</html>